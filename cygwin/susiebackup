#!/usr/bin/bash

#set variables
pg_dump="/home/Ryan/pgsql/bin/pg_dump.exe"
dump_path="C:\\Users\\ryan\\Documents\\Dropbox\\Sierra\\Backup\\"
current_date=$(date +%Y-%m-%d__%H-%M-%S)

fatal="0"

[[ ! -d "$dump_path" ]] && { echo "Dump path not found:""$dump_path"; fatal=1; }

[[ ! -f "$pg_dump" ]] && { echo "pg_dump not found:""$pg_dump"; fatal=1 ; }

[[ "$fatal" = 1 ]] && { echo "$(realpath $0): Critical files not found."; exit 1 }

backup_file="$dump_path""$current_date"".backup"
log_file="$dump_path""$current_date"".log"

echo "creating backup file... ""$backup_file"
echo "creating log file...""$log_file"

#create the backup#############################################
source ~/bin/cygwin/susie_dump "$backup_file" "$log_file"
error="$?"

#terminate on error
if [[ "$error" -ne "0" ]]; then
	echo "pg_dump returned exit code $error" ;
	exit "$error"
fi

#show backup stats so we don't restore something absurdly huge
#then ask if we want to continue or not
stat "$backup_file"

confirm "Do you want to attempt to restore? (y/n)"
[[ $? ]] || exit

#drop the sandbox##############################################
source ~/bin/cygwin/susie_drop 

#create the sandbox############################################
source ~/bin/cygwin/susie_create 
error="$?"

#terminate on error
if [[ "$error" -ne "0" ]]; then
	echo "pg_create returned exit code ""$error" ;
	exit "$error"
fi

#restore to sandbox############################################
source ~/bin/cygwin/susie_restore "$backup_file"
