#!/usr/bin/bash

#set variables
pg_dump="/home/Ryan/pgsql/bin/pg_dump.exe"
dump_path="C:\\Users\\ryan\\Documents\\Dropbox\\Sierra\\Backup\\"
current_date=$(date +%Y-%m-%d__%H-%M-%S)

fatal="0"

if [ ! -d "$dump_path" ]; then
	echo "Dump path not found:""$dump_path";
	fatal=1
fi

if [ ! -f "$pg_dump" ]; then
	echo "pg_dump not found:""$pg_dump";
	fatal=1
fi

if [ "$fatal" = 1 ]; then
	echo "FATAL: Critical files not found.";
	exit 1
fi

backup_file="$dump_path""$current_date"".backup"
log_file="$dump_path""$current_date"".log"

echo "creating backup file... ""$backup_file"
echo "creating log file...""$log_file"

#create the backup
source ~/bin/cygwin/susie_dump "$backup_file" "$log_file"
dump_error="$?"

#terminate on error
if [[ "$dump_error" -ne "0" ]]; then
	echo "pg_dump returned exit code ""$dump_error" ;
	exit "$dump_error"
fi

#show backup stats so we don't restore something absurdly huge
stat $backup_file

until [[ "$INPUT" == "y" ]]; do
        echo "Do you want to attempt to restore? (y/n)"
        read INPUT

        case $INPUT in
               y)
                        ;;     #nothing
               n)
               exit 1          #exit with error
                        ;;
               *)
        esac
done

#drop the sandbox, create the remote, restore to sandbox
source ~/bin/cygwin/susie_drop && source ~/bin/cygwin/susie_create && source ~/bin/cygwin/susie_restore "$backup_file"
