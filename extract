#!/usr/bin/env bash
#
# decompress archives based on mimetype
#
set -x

if [[ -f "$1" ]] ; then

    #get the mime type
    echo "Determining mimetype..."
        #this should use xdg-mime query filetype "$1" instead
    mime=$(file -Lb --mime-type "$1")
    echo "mimetype is: $mime"
    case "${mime#*-}" in
        bzip2)
        dep="bunzip2"
            cmd=(bunzip2 "$1")
            ;;
        tar.bz2)
            dep="tar"
            cmd=(tar kxjfv "$1")
            ;;
        tar.gz)
            dep="tar"
            cmd=(tar kxzfv "$1")
            ;;
        tar)
            dep="tar"
            cmd=(tar kxfv "$1")
            ;;
        tbz2)
            dep="tar"
            cmd=(tar kxjfv "$1")
            ;;
        tgz)
            dep="tar"
            cmd=(tar kxzfv "$1")
            ;;
        rar)
            dep="unrar"
            cmd=(unrar x "$1")
            ;;
        gzip)
            dep="gzip"
            cmd=(gzip -d --keep "$1")
            ;;
        application/zip)
            dep="unzip"
        cmd=(unzip -n -v "$1")
            ;;
        Z)
            dep="gzip"
            cmd=(gzip -vd --keep "$1")
            ;;
        7z-compressed)
            dep="7za"
            cmd=(7za x "$1")
            ;;
        *)
        echo "$(realpath $0) unrecognized mimetype $mime"
            exit 1
            ;;
    esac
    
    #Check for missing dependency
    [[ "$dep" ]] && type -P "$dep" > /dev/null || { echo "$(realpath $0): Missing dependency for MIME type $mime: $dep"; exit 1; }
    
    #Run the extraction command
    "${cmd[@]}"
    
    [[ -e "$1" ]] || echo "$(realpath $0): WARNING! $1 was removed after extracting."
    
else
    echo "$(realpath $0): $1 is not a valid file"
    exit 1
fi
