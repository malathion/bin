#!/usr/bin/bash
#
# decompress archives based on mimetype
#

if [[ -f "$1" ]] ; then
      
    #get the mime type
    mime="$(file -Lb --mime-type $1)"
    
    case "${mime#*-}" in
        bzip2)
            cmd=(bunzip2 "$1")
            ;;
        tar.bz2)
            dep="tar"
            cmd=(tar kxjfv "$1")
            ;;
        tar.gz)
            dep="tar"
            cmd=(tar kxzfv "$1")
            ;;
        tar)
            dep="tar"
            cmd=(tar kxfv "$1")
            ;;
        tbz2)
            dep="tar"
            cmd=(tar kxjfv "$1")
            ;;
        tgz)
            dep="tar"
            cmd=(tar kxzfv "$1")
            ;;
        rar)
            dep="unrar"
            cmd=(unrar x "$1")
            ;;
        gzip)
            dep="gzip"
            cmd=(gzip -d --keep "$1")
            ;;
        zip)
            dep="unzip"
            cmd=(unzip "$1")
            ;;
        Z)
            dep="uncompress"
            cmd=(uncompress "$1")
            ;;
        7z-compressed)
            dep="7za"
            cmd=(7za x "$1")
            ;;
        *)
            echo "extract: $mime unrecognized mimetype"
            exit 1
            ;;
    esac
    
    #Check for missing dependency
    [[ "$dep" ]] && type -P "$dep" > /dev/null || { echo "$(realpath $0): Missing dependency: $dep"; exit 1; }
    
    #Run the extraction command
    "${cmd[@]}"
    
    [[ -e "$1" ]] || echo "$(realpath $0): WARNING! $1 was removed after extracting."
    
else
	echo "$(realpath $0): $1 is not a valid file"
    exit 1
fi
